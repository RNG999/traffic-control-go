name: Issue Management

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]

  issue_comment:
    types: [created]

jobs:
  auto-close-on-success:
    if: github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.name == 'CI'
    runs-on: ubuntu-latest
    name: Auto-close Issues on Successful CI
    steps:
      - name: Get PR associated with workflow run
        id: get-pr
        uses: actions/github-script@v7
        with:
          script: |
            const runId = context.payload.workflow_run.id;
            const headSha = context.payload.workflow_run.head_sha;
            
            // workflow runã«é–¢é€£ã™ã‚‹PRã‚’æ¤œç´¢
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`,
              sort: 'updated',
              direction: 'desc'
            });
            
            let associatedPR = null;
            for (const pr of pulls) {
              if (pr.head.sha === headSha) {
                associatedPR = pr;
                break;
              }
            }
            
            if (associatedPR && associatedPR.merged) {
              console.log(`âœ… Found merged PR #${associatedPR.number} for successful CI run`);
              
              // è¿½åŠ æ¤œè¨¼: ã™ã¹ã¦ã®å¿…é ˆãƒã‚§ãƒƒã‚¯ãŒå®Œäº†ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
              const { data: checkRuns } = await github.rest.checks.listForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: headSha
              });
              
              const requiredChecks = ['validate-issue-link', 'validate-pr-format', 'test', 'lint'];
              let allChecksPass = true;
              let checkStatus = {};
              
              for (const check of checkRuns.check_runs) {
                if (requiredChecks.includes(check.name)) {
                  checkStatus[check.name] = check.conclusion;
                  if (check.conclusion !== 'success') {
                    allChecksPass = false;
                    console.log(`âŒ Check '${check.name}' status: ${check.conclusion}`);
                  } else {
                    console.log(`âœ… Check '${check.name}' passed`);
                  }
                }
              }
              
              console.log('All checks status:', checkStatus);
              
              if (allChecksPass) {
                console.log('âœ… All required checks passed - safe to close issues');
                core.setOutput('pr-number', associatedPR.number.toString());
                core.setOutput('pr-title', associatedPR.title);
                core.setOutput('pr-body', associatedPR.body || '');
                core.setOutput('has-pr', 'true');
              } else {
                console.log('âš ï¸ Not all required checks passed - skipping issue closure');
                core.setOutput('has-pr', 'false');
              }
            } else {
              console.log('â„¹ï¸ No merged PR found for this workflow run');
              core.setOutput('has-pr', 'false');
            }

      - name: Close Issues After Successful CI
        if: steps.get-pr.outputs.has-pr == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = '${{ steps.get-pr.outputs.pr-number }}';
            const prTitle = '${{ steps.get-pr.outputs.pr-title }}';
            const prBody = '${{ steps.get-pr.outputs.pr-body }}';
            
            // Issueç•ªå·ã‚’æŠ½å‡ºï¼ˆè‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºå¯¾è±¡ã®ã¿ï¼‰
            const autoClosePatterns = [
              /(?:close|closes|closed|fix|fixes|fixed|resolve|resolves|resolved)\s+#(\d+)/gi,
              /(?:close|closes|closed|fix|fixes|fixed|resolve|resolves|resolved)\s+https:\/\/github\.com\/[^\/]+\/[^\/]+\/issues\/(\d+)/gi
            ];
            
            const textToCheck = prTitle + ' ' + prBody;
            let issuesToClose = [];
            
            for (const pattern of autoClosePatterns) {
              let match;
              while ((match = pattern.exec(textToCheck)) !== null) {
                const issueNumber = match[1];
                if (!issuesToClose.includes(issueNumber)) {
                  issuesToClose.push(issueNumber);
                }
              }
            }
            
            console.log(`ğŸ“‹ Found ${issuesToClose.length} issues to close from PR #${prNumber}`);
            
            // Issueã‚’å®Ÿéš›ã«ã‚¯ãƒ­ãƒ¼ã‚º
            for (const issueNumber of issuesToClose) {
              try {
                // ã¾ãšIssueã®ç¾åœ¨ã®çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
                const { data: issue } = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(issueNumber)
                });
                
                if (issue.state === 'open') {
                  // å®Œäº†ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: parseInt(issueNumber),
                    body: `ğŸ¯ **Issue Completed Successfully!**\n\n` +
                          `âœ… **All CI/CD checks passed** for PR #${prNumber}\n` +
                          `   â€¢ Issue linking validation âœ…\n` +
                          `   â€¢ PR format validation âœ…\n` +
                          `   â€¢ Test suite âœ…\n` +
                          `   â€¢ Code linting âœ…\n` +
                          `ğŸš€ Changes have been successfully merged to main branch\n` +
                          `ğŸ“‹ PR Title: "${prTitle}"\n\n` +
                          `This issue is now resolved and will be closed automatically.\n\n` +
                          `---\n` +
                          `ğŸ¤– Automated by GitHub Actions â€¢ Generated with [Claude Code](https://claude.ai/code)`
                  });
                  
                  // Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚º
                  await github.rest.issues.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: parseInt(issueNumber),
                    state: 'closed',
                    state_reason: 'completed'
                  });
                  
                  console.log(`âœ… Successfully closed issue #${issueNumber}`);
                  core.notice(`Issue #${issueNumber} has been automatically closed after successful CI`);
                } else {
                  console.log(`â„¹ï¸ Issue #${issueNumber} is already ${issue.state}`);
                }
              } catch (error) {
                console.log(`âŒ Failed to close issue #${issueNumber}:`, error.message);
                core.warning(`Failed to close issue #${issueNumber}: ${error.message}`);
              }
            }

  handle-issue-commands:
    if: github.event.issue_comment.created
    runs-on: ubuntu-latest
    name: Handle Issue Commands
    steps:
      - name: Process Issue Commands
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body.toLowerCase().trim();
            const issueNumber = context.payload.issue.number;
            const commenter = context.payload.comment.user.login;
            const issueAuthor = context.payload.issue.user.login;
            
            // æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼šIssueä½œæˆè€…ã€collaboratorã€ã¾ãŸã¯ownerã®ã¿ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œå¯èƒ½
            const { data: permissions } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: commenter
            });
            
            const hasPermission = ['admin', 'maintain', 'write'].includes(permissions.permission) || 
                                commenter === issueAuthor ||
                                commenter === context.repo.owner;
            
            if (!hasPermission) {
              console.log(`âŒ User @${commenter} does not have permission to execute commands`);
              return;
            }
            
            // /close ã‚³ãƒãƒ³ãƒ‰
            if (comment === '/close' || comment === '/done') {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `âœ… Issue marked as completed by @${commenter}\n\n` +
                      `---\n` +
                      `ğŸ¤– Automated by GitHub Actions`
              });
              
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                state: 'closed',
                state_reason: 'completed'
              });
              
              console.log(`âœ… Issue #${issueNumber} closed by command from @${commenter}`);
            }
            
            // /reopen ã‚³ãƒãƒ³ãƒ‰
            else if (comment === '/reopen') {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                state: 'open'
              });
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `ğŸ”„ Issue reopened by @${commenter}\n\n` +
                      `---\n` +
                      `ğŸ¤– Automated by GitHub Actions`
              });
              
              console.log(`ğŸ”„ Issue #${issueNumber} reopened by command from @${commenter}`);
            }
            
            // /help ã‚³ãƒãƒ³ãƒ‰
            else if (comment === '/help' || comment === '/commands') {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `ğŸ¤– **Available Commands**\n\n` +
                      `â€¢ \`/close\` or \`/done\` - Mark issue as completed and close\n` +
                      `â€¢ \`/reopen\` - Reopen a closed issue\n` +
                      `â€¢ \`/help\` or \`/commands\` - Show this help message\n\n` +
                      `**Automatic Actions:**\n` +
                      `â€¢ Issues are automatically closed when PR with "Fixes #${issueNumber}" is merged and CI passes\n` +
                      `â€¢ PRs must reference issue numbers (checked automatically)\n\n` +
                      `---\n` +
                      `ğŸ¤– Automated by GitHub Actions`
              });
              
              console.log(`â„¹ï¸ Help message sent to issue #${issueNumber} for @${commenter}`);
            }