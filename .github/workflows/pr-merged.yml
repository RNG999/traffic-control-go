name: PR Merged Actions

on:
  pull_request:
    types: [closed]

jobs:
  handle-merged-pr:
    if: github.event.pull_request.merged == true && github.event.action == 'closed'
    runs-on: ubuntu-latest
    name: Handle Merged PR
    steps:
      - name: Extract Issue Numbers
        id: extract-issues
        uses: actions/github-script@v7
        with:
          script: |
            console.log('=== PR MERGED WORKFLOW DEBUG ===');
            console.log('Event action:', context.payload.action);
            console.log('PR merged:', context.payload.pull_request.merged);
            console.log('PR state:', context.payload.pull_request.state);
            console.log('PR number:', context.payload.pull_request.number);
            
            const title = context.payload.pull_request.title;
            const body = context.payload.pull_request.body || '';
            const prNumber = context.payload.pull_request.number;
            
            // Issueç•ªå·ã‚’æŠ½å‡ºï¼ˆFixes/Closes/Resolveså½¢å¼ã®ã¿è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºå¯¾è±¡ï¼‰
            const autoClosePatterns = [
              /(?:close|closes|closed|fix|fixes|fixed|resolve|resolves|resolved)\s+#(\d+)/gi,
              /(?:close|closes|closed|fix|fixes|fixed|resolve|resolves|resolved)\s+https:\/\/github\.com\/[^\/]+\/[^\/]+\/issues\/(\d+)/gi
            ];
            
            // ã‚·ãƒ³ãƒ—ãƒ«ãªå‚ç…§ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆè‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºã—ãªã„ï¼‰
            const referencePattern = /#(\d+)/g;
            
            const textToCheck = title + ' ' + body;
            let autoCloseIssues = [];
            let referencedIssues = [];
            
            // è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºå¯¾è±¡ã®Issueã‚’æŠ½å‡º
            for (const pattern of autoClosePatterns) {
              let match;
              while ((match = pattern.exec(textToCheck)) !== null) {
                const issueNumber = match[1];
                if (!autoCloseIssues.includes(issueNumber)) {
                  autoCloseIssues.push(issueNumber);
                }
              }
            }
            
            // ã™ã¹ã¦ã®å‚ç…§ã•ã‚ŒãŸIssueã‚’æŠ½å‡º
            let match;
            while ((match = referencePattern.exec(textToCheck)) !== null) {
              const issueNumber = match[1];
              if (!referencedIssues.includes(issueNumber) && !autoCloseIssues.includes(issueNumber)) {
                referencedIssues.push(issueNumber);
              }
            }
            
            console.log('Auto-close issues:', autoCloseIssues);
            console.log('Referenced issues:', referencedIssues);
            
            core.setOutput('auto-close-issues', JSON.stringify(autoCloseIssues));
            core.setOutput('referenced-issues', JSON.stringify(referencedIssues));
            core.setOutput('pr-number', prNumber.toString());

      - name: Comment on Referenced Issues
        uses: actions/github-script@v7
        with:
          script: |
            const autoCloseIssues = JSON.parse('${{ steps.extract-issues.outputs.auto-close-issues }}');
            const referencedIssues = JSON.parse('${{ steps.extract-issues.outputs.referenced-issues }}');
            const prNumber = '${{ steps.extract-issues.outputs.pr-number }}';
            const prUrl = context.payload.pull_request.html_url;
            const prTitle = context.payload.pull_request.title;
            
            // è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã‚‹Issueã«ã‚³ãƒ¡ãƒ³ãƒˆ
            for (const issueNumber of autoCloseIssues) {
              try {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(issueNumber),
                  body: `ğŸ‰ This issue has been resolved by PR #${prNumber}: "${prTitle}"\n\n` +
                        `ğŸ”— Pull Request: ${prUrl}\n\n` +
                        `This issue will be automatically closed when the PR is merged.\n\n` +
                        `---\n` +
                        `ğŸ¤– Generated with [Claude Code](https://claude.ai/code)`
                });
                console.log(`âœ… Commented on issue #${issueNumber}`);
              } catch (error) {
                console.log(`âŒ Failed to comment on issue #${issueNumber}:`, error.message);
              }
            }
            
            // å‚ç…§ã®ã¿ã®Issueã«ã‚³ãƒ¡ãƒ³ãƒˆ
            for (const issueNumber of referencedIssues) {
              try {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(issueNumber),
                  body: `ğŸ”— This issue was referenced in PR #${prNumber}: "${prTitle}"\n\n` +
                        `ğŸ“‹ Pull Request: ${prUrl}\n\n` +
                        `---\n` +
                        `ğŸ¤– Generated with [Claude Code](https://claude.ai/code)`
                });
                console.log(`âœ… Referenced comment added to issue #${issueNumber}`);
              } catch (error) {
                console.log(`âŒ Failed to comment on issue #${issueNumber}:`, error.message);
              }
            }

      - name: Update Project Status
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = '${{ steps.extract-issues.outputs.pr-number }}';
            const prUrl = context.payload.pull_request.html_url;
            const prTitle = context.payload.pull_request.title;
            const mergedBy = context.payload.pull_request.merged_by.login;
            
            // PRãƒãƒ¼ã‚¸ã®é€šçŸ¥ã‚’Issueã«ã‚³ãƒ¡ãƒ³ãƒˆ
            core.notice(`âœ… PR #${prNumber} merged successfully: ${prTitle}`);
            console.log(`ğŸ‰ PR #${prNumber} was merged by @${mergedBy}`);
            console.log(`ğŸ“‹ Title: ${prTitle}`);
            console.log(`ğŸ”— URL: ${prUrl}`);

  cleanup-on-close:
    if: github.event.pull_request.merged == false && github.event.action == 'closed'
    runs-on: ubuntu-latest
    name: Handle Closed PR
    steps:
      - name: Notify PR Closed Without Merge
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const prTitle = context.payload.pull_request.title;
            const closedBy = context.payload.pull_request.closed_by.login;
            
            console.log(`âŒ PR #${prNumber} was closed without merging by @${closedBy}`);
            console.log(`ğŸ“‹ Title: ${prTitle}`);
            
            core.warning(`PR #${prNumber} was closed without merging`);